DECLARE @DISPNAME nvarchar(23);
DECLARE @LIFESPANACTION int;
DECLARE @WSQL nvarchar(max);
DECLARE @WSQLJET nvarchar(max);
DECLARE @WSQLSQL nvarchar(max);

SET @DISPNAME = 'HealthDetail';
SET @LIFESPANACTION = 2;
SET @WSQL = 
'SELECT
 WGUID
 , GETUTCDATE() AS VWTIME
 , 1 AS ACTIVESTATUS
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND WTYPE = 0
 AND APPARENT_CPU > 0.95
 )
 AS CPU_USAGE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND WTYPE = 0
 AND PROC_QUEUE >
 (
 SELECT
 TOP 1 SYNUMPROC
 FROM
 SASCFG AS T2
 WHERE
 T2.WGUID = T1.WGUID
 )
 + 1
 )
 AS CPU_QUEUE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(DISK_Q_LEN) > 1
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_QUEUE_LENGTH_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(SEC_XFER-(DISK_TIME/(READS+WRITES+0.01))) > 0.01
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_QUEUE_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(DISK_TIME/(READS+WRITES+0.01)) > 0.02
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_SERVICE_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(DISK_TIME) > 0.8
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(SEC_XFER) > 0.02
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_XFER_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND WTYPE = 0
 AND INT_CPU > 0.25
 )
 AS HARDWARE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPING AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND SESSIONNUM = -1
 AND RESPTIME > 5
 )
 AS LATENCY_GATEWAY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPING AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND SESSIONNUM = -4
 AND RESPTIME > 25
 )
 AS LATENCY_HOME_DIRECTORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAICA AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND LAT_LAST_REC > 100
 )
 AS LATENCY_ICA_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPCOIP AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND ROUND_TRIP_LATENCY_MS > 100
 )
 AS LATENCY_PCOIP_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND VNC_EST_RTT > 100
 )
 AS LATENCY_BLAST_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST2 AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND SESS_RTT > 100
 )
 AS LATENCY_BLAST2_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAREMOTEFX AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND CUR_UDP_RTT > 100
 )
 AS LATENCY_REMOTEFX_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND WTYPE =0
 AND AVAIL_BYTE < 50000000
 )
 AS MEMORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(BYTE_RATE) > 100*1024*1024
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS NETWORK_BYTE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(REXMIT) > 0.1
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS NETWORK_REXMIT_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(NET_UTIL) > 0.3
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS NETWORK_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAVMWARE AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND MEMBALLOONED > 0
 )
 AS VMACHINE_MEMORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAVMWARE AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 AND CPUSTOLEN/15000 > 0.1
 )
 AS VMACHINE_CPU_READY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND WTYPE = 0
 AND (COMMIT_BYT / COMMIT_LIM) > 0.9
 )
 AS VMEMORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND WTYPE = 0
 )
 AS SASYS_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS SADSK_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SAICA AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 )
 AS SAICA_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPCOIP AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 )
 AS SAPCOIP_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 )
 AS SABLAST_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST2 AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 )
 AS SABLAST2_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SAREMOTEFX AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND WUSAGE = 3
 AND T1.WTYPE = 0
 )
 AS SAREMOTEFX_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS SANET_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SAVMWARE AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 WUSAGE = 3
 AND T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS SAVMWARE_RECORDED
FROM
 (
 SELECT
 TOP 1 WGUID
 FROM
 SAGUIDS
 ORDER BY
 CFGLOADTIME DESC
 )
 AS T0
UNION
SELECT
 WGUID
 , GETUTCDATE() AS VWTIME
 , 0 AS ACTIVESTATUS
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WTYPE = 0
 AND APPARENT_CPU > 0.95
 )
 AS CPU_USAGE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WTYPE = 0
 AND PROC_QUEUE >
 (
 SELECT
 TOP 1 SYNUMPROC
 FROM
 SASCFG AS T2
 WHERE
 T2.WGUID = T1.WGUID
 )
 + 1
 )
 AS CPU_QUEUE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(DISK_Q_LEN) > 1
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_QUEUE_LENGTH_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(SEC_XFER-(DISK_TIME/(READS+WRITES+0.01))) > 0.01
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_QUEUE_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(DISK_TIME/(READS+WRITES+0.01)) > 0.02
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_SERVICE_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(DISK_TIME) > 0.8
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(READS + WRITES) > 5
 AND MAX(SEC_XFER) > 0.02
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS DISK_XFER_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WTYPE = 0
 AND INT_CPU > 0.25
 )
 AS HARDWARE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPING AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND SESSIONNUM = -1
 AND RESPTIME > 5
 )
 AS LATENCY_GATEWAY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPING AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND SESSIONNUM = -4
 AND RESPTIME > 25
 )
 AS LATENCY_HOME_DIRECTORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAICA AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND LAT_LAST_REC > 100
 )
 AS LATENCY_ICA_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPCOIP AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND ROUND_TRIP_LATENCY_MS > 100
 )
 AS LATENCY_PCOIP_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND VNC_EST_RTT > 100
 )
 AS LATENCY_BLAST_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST2 AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND SESS_RTT > 100
 )
 AS LATENCY_BLAST2_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAREMOTEFX AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND CUR_UDP_RTT > 100
 )
 AS LATENCY_REMOTEFX_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WTYPE =0
 AND AVAIL_BYTE < 50000000
 )
 AS MEMORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(BYTE_RATE) > 100*1024*1024
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS NETWORK_BYTE_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(REXMIT) > 0.1
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS NETWORK_REXMIT_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 HAVING
 MAX(NET_UTIL) > 0.3
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS NETWORK_TIME_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAVMWARE AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND MEMBALLOONED > 0
 )
 AS VMACHINE_MEMORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SAVMWARE AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 AND CPUSTOLEN/15000 > 0.1
 )
 AS VMACHINE_CPU_READY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WTYPE = 0
 AND (COMMIT_BYT / COMMIT_LIM) > 0.9
 )
 AS VMEMORY_IMPACTED
 , (
 SELECT
 COUNT(*)
 FROM
 SASYS AS T1
 WHERE
 T1.WGUID = T0.WGUID
 AND WTYPE = 0
 )
 AS SASYS_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SADSK AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS SADSK_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SAICA AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 )
 AS SAICA_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SAPCOIP AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 )
 AS SAPCOIP_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 )
 AS SABLAST_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SABLAST2 AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 )
 AS SABLAST2_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 SAREMOTEFX AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTIME = T2.WTIME
 AND T1.WTYPE = T2.WTYPE
 WHERE
 T1.WGUID = T0.WGUID
 AND T1.WTYPE = 0
 )
 AS SAREMOTEFX_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SANET AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS SANET_RECORDED
 , (
 SELECT
 COUNT(*)
 FROM
 (
 SELECT
 T1.WGUID
 , T1.WTIME
 FROM
 SAVMWARE AS T1
 INNER JOIN
 SASYS AS T2
 ON
 T1.WGUID = T2.WGUID
 AND T1.WTYPE = T2.WTYPE
 AND T1.WTIME = T2.WTIME
 WHERE
 T1.WTYPE = 0
 GROUP BY
 T1.WGUID
 , T1.WTIME
 )
 AS T3
 WHERE
 T3.WGUID = T0.WGUID
 )
 AS SAVMWARE_RECORDED
FROM
 (
 SELECT
 TOP 1 WGUID
 FROM
 SAGUIDS
 ORDER BY
 CFGLOADTIME DESC
 )
 AS T0';
 SET @WSQLJET = '';
 SET @WSQLSQL = '';


IF (SELECT COUNT(*) FROM SAVIEWS WHERE DISPNAME = @DISPNAME) = 0
BEGIN
	INSERT INTO SAVIEWS
           (VIEWID
           ,DISPNAME
           ,WDESC
           ,WTABLE
           ,WFLAGS
           ,WTYPE
           ,LASTTIME
           ,LIFESPAN
           ,LIFESPANTYPE
           ,LIFESPANACTION
           ,REFRESHTYPE
           ,REFRESHACTION
           ,REFRESH
           ,OVERDUEDAYS
           ,TIMEWINDOW
           ,WSQLGUIDS
           ,WSQL
           ,WSQLJET
           ,WSQLSQL
           ,WSQLORACLE)
     VALUES
           (CASE WHEN (SELECT MAX(VIEWID) FROM SAVIEWS) < 1000000 THEN 1000000 ELSE (SELECT MAX(VIEWID) FROM SAVIEWS) + 1 END
           ,@DISPNAME
           ,''
           ,'VU' + @DISPNAME
           ,64
           ,0
           ,'1899-12-30 00:00:00.000'
           ,30
           ,3
           ,@LIFESPANACTION
           ,0
           ,0
           ,1
           ,0
           ,'24x7'
           ,'SELECT WGUID FROM SAGUIDS'
           ,@WSQL
           ,@WSQLJET
           ,@WSQLSQL
           ,'');
        SELECT
               @DISPNAME + N'を追加しました。' AS MSG
END ELSE BEGIN
	IF (SELECT COUNT(*) FROM SAVIEWS WHERE DISPNAME = @DISPNAME AND LIFESPANACTION = @LIFESPANACTION AND WSQL = @WSQL AND WSQLJET = @WSQLJET AND WSQLSQL = @WSQLSQL) = 0
	BEGIN
		UPDATE SAVIEWS
              SET
                     LIFESPANACTION = @LIFESPANACTION
                     ,WSQL = @WSQL
                     ,WSQLJET = @WSQLJET
                     ,WSQLSQL = @WSQLSQL
              WHERE
                     DISPNAME = @DISPNAME;
              SELECT
				   @DISPNAME + N'を更新しました。' AS MSG
	END ELSE BEGIN
        SELECT
               @DISPNAME + N'は既に存在します。' AS MSG
   END
END
